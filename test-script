--// LocalScript (StarterPlayerScripts)
-- One-loop automation:
-- place -> wait 3s -> potions (40) -> teleport to each placed pack & press E -> repeat
-- Failsafe: if no models in placed packs folder, skip potions/open and keep placing.
-- If no models are found for 30 seconds total, stop the loop (assume out of packs).

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- Remotes
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local cardPack = Remotes:WaitForChild("Card")
local potionRemote = Remotes:WaitForChild("Potion")

-- === QUAD CORNERS ===
-- B(top-left) -> C(top-right) -> D(bottom-right) -> A(bottom-left)
local A = Vector3.new(-622.432373, 7.22039652, -92.1760025)
local B = Vector3.new(-621.693604, 7.1538558,  -150.819366)
local C = Vector3.new(-570.654053, 7.1538558,  -152.937439)
local D = Vector3.new(-570.425293, 7.1538558,  -93.1411057)

-- === TUNING ===
-- Placement sweep
local STEP_STUDS = 7.0
local ROW_STEP_STUDS = 7.0
local Y_LIFT = 2.5
local TELEPORT_WAIT = 0.08
local PLACE_EVERY_N_STEPS = 1
local PACK_NAME = "Note-Emerald"
local PLACE_COOLDOWN = 0.08

-- Loop pacing
local AFTER_PLACE_WAIT = 3.0

-- Potions
local POTION_NAME = "HatchTime1"
local POTION_USES = 40
local POTION_DELAY = 0.10 -- delay between potion fires (raise if throttled)

-- Opening packs
local OPEN_KEY = Enum.KeyCode.E
local OPEN_AFTER_TELEPORT_DELAY = 0.12
local BETWEEN_PACKS_DELAY = 0.05
local OPEN_PRESS_DURATION = 0.05

-- Failsafe
local NO_MODEL_TIMEOUT = 30.0  -- seconds with zero models before auto-stop

-- Plot path
local PLOTS_FOLDER_NAME = "Plots"
local PLOT_ID_FOLDER_NAME = "1"
local PLACED_PACKS_FOLDER_NAME = "Packs"

-- Toggle key
local TOGGLE_KEY = Enum.KeyCode.P

-- =========================
-- Helpers
-- =========================
local function getCharacterParts()
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart", 5)
	local hum = char:FindFirstChildOfClass("Humanoid")
	return char, hrp, hum
end

local function v3Lerp(a, b, t)
	return a + (b - a) * t
end

local function stepsForDistance(dist, step)
	return math.max(1, math.floor(dist / step + 0.5))
end

local function teleportTo(hrp, pos, lookDir)
	local p = pos + Vector3.new(0, Y_LIFT, 0)
	if lookDir and lookDir.Magnitude > 1e-6 then
		hrp.CFrame = CFrame.lookAt(p, p + lookDir.Unit)
	else
		hrp.CFrame = CFrame.new(p)
	end
end

local function placePack()
	cardPack:FireServer("Place", PACK_NAME)
end

local function pressKey(keyCode, holdSeconds)
	VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
	task.wait(holdSeconds or 0.03)
	VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
end

local function getModelWorldPos(model: Model): Vector3?
	if not model or not model:IsA("Model") then return nil end

	local ok, pivot = pcall(function()
		return model:GetPivot()
	end)
	if ok and pivot then
		return pivot.Position
	end

	if model.PrimaryPart then
		return model.PrimaryPart.Position
	end

	local bp = model:FindFirstChildWhichIsA("BasePart", true)
	return bp and bp.Position or nil
end

local function getPlacedPacksFolder()
	local plots = Workspace:FindFirstChild(PLOTS_FOLDER_NAME)
	if not plots then return nil end
	local plot = plots:FindFirstChild(PLOT_ID_FOLDER_NAME)
	if not plot then return nil end
	local packs = plot:FindFirstChild(PLACED_PACKS_FOLDER_NAME)
	return packs
end

local function getPlacedPackModels()
	local folder = getPlacedPacksFolder()
	if not folder then return {} end

	local models = {}
	for _, child in ipairs(folder:GetChildren()) do
		if child:IsA("Model") then
			table.insert(models, child)
		end
	end
	return models
end

local function applyPotions(runningFlag)
	print(("[Loop] Applying %d potions (%s)..."):format(POTION_USES, POTION_NAME))
	for i = 1, POTION_USES do
		if not runningFlag() then return false end
		potionRemote:FireServer("Apply", POTION_NAME)
		if POTION_DELAY > 0 then
			task.wait(POTION_DELAY)
		end
	end
	print("[Loop] Potion phase complete.")
	return true
end

local function openModels(models, runningFlag)
	local _, hrp = getCharacterParts()
	if not hrp then
		warn("[Loop] No HumanoidRootPart found.")
		return false
	end

	print(("[Loop] Opening %d placed pack models..."):format(#models))

	-- Greedy nearest-first ordering to reduce travel
	local function distToHRP(m)
		local p = getModelWorldPos(m)
		if not p then return math.huge end
		return (p - hrp.Position).Magnitude
	end

	local remaining = table.clone(models)
	local ordered = {}

	while #remaining > 0 do
		if not runningFlag() then return false end
		table.sort(remaining, function(m1, m2)
			return distToHRP(m1) < distToHRP(m2)
		end)
		table.insert(ordered, table.remove(remaining, 1))
	end

	for i, model in ipairs(ordered) do
		if not runningFlag() then return false end

		local pos = getModelWorldPos(model)
		if pos then
			print(("[Loop] (%d/%d) Teleport+Open: %s"):format(i, #ordered, model.Name))

			local lookDir = (pos - hrp.Position)
			teleportTo(hrp, pos, lookDir)

			task.wait(OPEN_AFTER_TELEPORT_DELAY)
			pressKey(OPEN_KEY, OPEN_PRESS_DURATION)

			if BETWEEN_PACKS_DELAY > 0 then
				task.wait(BETWEEN_PACKS_DELAY)
			end
		end
	end

	print("[Loop] Open phase complete.")
	return true
end

-- =========================
-- Place sweep (one full zigzag pass)
-- =========================
local function zigzagPlaceSweep(runningFlag)
	local _, hrp = getCharacterParts()
	if not hrp then
		warn("[Loop] No HumanoidRootPart found.")
		return false
	end

	local topLen = (C - B).Magnitude
	local leftLen = (A - B).Magnitude
	local cols = stepsForDistance(topLen, STEP_STUDS)
	local rows = stepsForDistance(leftLen, ROW_STEP_STUDS)

	print(string.format("[Loop] Place sweep: cols=%d rows=%d", cols, rows))

	local globalStep = 0
	local nextPlaceTime = 0

	for r = 0, rows do
		if not runningFlag() then return false end

		local rt = r / rows
		local rowStart = v3Lerp(B, A, rt)
		local rowEnd   = v3Lerp(C, D, rt)
		local rowDir = (rowEnd - rowStart)
		local leftToRight = (r % 2 == 0)

		for c = 0, cols do
			if not runningFlag() then return false end

			local ct = c / cols
			local t = leftToRight and ct or (1 - ct)
			local pos = v3Lerp(rowStart, rowEnd, t)

			teleportTo(hrp, pos, rowDir)

			if TELEPORT_WAIT > 0 then
				task.wait(TELEPORT_WAIT)
			end

			globalStep += 1
			if (globalStep % PLACE_EVERY_N_STEPS) == 0 then
				local now = os.clock()
				if now >= nextPlaceTime then
					placePack()
					nextPlaceTime = now + PLACE_COOLDOWN
				end
			end
		end
	end

	return true
end

-- =========================
-- Main loop
-- =========================
local running = false
local loopThread = nil

local function isRunning()
	return running
end

local function mainLoop()
	print("[Loop] Started. (Press P to stop)")
	local lastFoundModelTime = os.clock()

	while running do
		-- 1) Place sweep
		local ok = zigzagPlaceSweep(isRunning)
		if not ok then break end

		-- 2) Wait 3 seconds
		local startWait = os.clock()
		while running and (os.clock() - startWait) < AFTER_PLACE_WAIT do
			task.wait(0.1)
		end
		if not running then break end

		-- 3) Check placed packs folder
		local models = getPlacedPackModels()

		if #models == 0 then
			-- No models -> skip potions/open and keep trying to place
			local now = os.clock()
			local elapsedNoModels = now - lastFoundModelTime

			print(string.format("[Loop] No placed pack models found. (%.1fs without models)", elapsedNoModels))

			-- failsafe
			if elapsedNoModels >= NO_MODEL_TIMEOUT then
				warn("[Loop] No models found for 30s. Assuming out of packs. Auto-stopping.")
				running = false
				break
			end

			-- tiny yield so we don't hard-spin
			task.wait(0.2)
		else
			-- Found models -> reset failsafe timer
			lastFoundModelTime = os.clock()
			print(("[Loop] Found %d placed pack models. Proceeding to potions + open."):format(#models))

			-- 4) Potions (40)
			local okPotions = applyPotions(isRunning)
			if not okPotions then break end

			-- Re-fetch models (some games update list as you open)
			models = getPlacedPackModels()
			if #models > 0 then
				-- 5) Teleport and press E
				local okOpen = openModels(models, isRunning)
				if not okOpen then break end
			else
				print("[Loop] After potions, no models present to open (skipping open).")
			end

			-- Small pause to keep things stable between cycles
			task.wait(0.25)
		end
	end

	print("[Loop] Stopped.")
end

local function toggle()
	running = not running
	print("[Loop] Running:", running)

	if running then
		-- reset loop thread
		loopThread = task.spawn(mainLoop)
	end
end

UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == TOGGLE_KEY then
		toggle()
	end
end)

print("[Loaded] Press P to start/stop the full loop.")
