--// LocalScript (StarterPlayerScripts)
-- Zigzag teleport scan across a quad and place packs at each step.

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- Remote
local cardPack = ReplicatedStorage.Remotes:WaitForChild("Card")

-- === QUAD CORNERS (same ones you provided) ===
-- Using the perimeter order that matched your visual outline:
-- B(top-left) -> C(top-right) -> D(bottom-right) -> A(bottom-left)
local A = Vector3.new(-622.432373, 7.22039652, -92.1760025)     -- bottom-left-ish
local B = Vector3.new(-621.693604, 7.1538558,  -150.819366)    -- top-left
local C = Vector3.new(-570.654053, 7.1538558,  -152.937439)    -- top-right
local D = Vector3.new(-570.425293, 7.1538558,  -93.1411057)    -- bottom-right-ish

-- === TUNING ===
local STEP_STUDS = 7.0           -- distance between columns
local ROW_STEP_STUDS = 7.0       -- distance between rows
local Y_LIFT = 2.5               -- lift HRP above the surface when teleporting

local TELEPORT_WAIT = 0.02       -- 0 = as fast as possible; >0 adds stability delay
local PLACE_EVERY_N_STEPS = 1    -- attempt placing every N teleports
local PACK_NAME = "Note-Emerald"

-- NEW: time-based place limiter (replaces PLACE_WAIT blocking)
local PLACE_COOLDOWN = 0.18      -- seconds between Place fires (try 0.08 to 0.20)

-- Toggle key
local TOGGLE_KEY = Enum.KeyCode.P

-- === Helpers ===
local function getCharacterParts()
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart", 5)
	local hum = char:FindFirstChildOfClass("Humanoid")
	return char, hrp, hum
end

local function v3Lerp(a, b, t)
	return a + (b - a) * t
end

-- Distance-based step count (at least 1)
local function stepsForDistance(dist, step)
	return math.max(1, math.floor(dist / step + 0.5))
end

-- Teleport HRP to world position (keep facing along row direction)
local function teleportTo(hrp, pos, lookDir)
	local p = pos + Vector3.new(0, Y_LIFT, 0)
	if lookDir and lookDir.Magnitude > 1e-6 then
		hrp.CFrame = CFrame.lookAt(p, p + lookDir.Unit)
	else
		hrp.CFrame = CFrame.new(p)
	end
end

-- Place pack
local function placePack()
	cardPack:FireServer("Place", PACK_NAME)
end

-- === Zigzag scan ===
local running = false
local scanThread = nil

local function zigzagScan()
	local _, hrp = getCharacterParts()
	if not hrp then
		warn("[Zigzag] No HumanoidRootPart found.")
		return
	end

	print("[Zigzag] Starting scan... (toggle with P to stop)")

	-- Define edges:
	-- Top edge: B -> C
	-- Bottom edge: A -> D
	-- Left edge: B -> A
	-- Right edge: C -> D
	local topLen = (C - B).Magnitude
	local leftLen = (A - B).Magnitude

	local cols = stepsForDistance(topLen, STEP_STUDS)
	local rows = stepsForDistance(leftLen, ROW_STEP_STUDS)

	print(string.format("[Zigzag] cols=%d rows=%d (STEP=%.2f ROW_STEP=%.2f)", cols, rows, STEP_STUDS, ROW_STEP_STUDS))
	print(string.format("[Zigzag] TELEPORT_WAIT=%.3f PLACE_COOLDOWN=%.3f", TELEPORT_WAIT, PLACE_COOLDOWN))

	local globalStep = 0
	local nextPlaceTime = 0 -- NEW: rate limit timer

	for r = 0, rows do
		if not running then break end

		local rt = r / rows

		-- Row endpoints are interpolated down the left/right edges
		local rowStart = v3Lerp(B, A, rt) -- left side
		local rowEnd   = v3Lerp(C, D, rt) -- right side

		-- Row direction (for facing)
		local rowDir = (rowEnd - rowStart)

		-- Zigzag direction
		local leftToRight = (r % 2 == 0)

		for c = 0, cols do
			if not running then break end

			local ct = c / cols
			local t = leftToRight and ct or (1 - ct)
			local pos = v3Lerp(rowStart, rowEnd, t)

			teleportTo(hrp, pos, rowDir)

			-- Only wait if TELEPORT_WAIT > 0
			if TELEPORT_WAIT > 0 then
				task.wait(TELEPORT_WAIT)
			end

			globalStep += 1

			-- Attempt to place based on step cadence, but rate-limited by time
			if (globalStep % PLACE_EVERY_N_STEPS) == 0 then
				local now = os.clock()
				if now >= nextPlaceTime then
					placePack()
					nextPlaceTime = now + PLACE_COOLDOWN
				end
			end
		end
	end

	print("[Zigzag] Scan finished.")
	running = false
end

-- Toggle handler
local function toggle()
	running = not running
	print("[Zigzag] Running:", running)

	if running then
		scanThread = task.spawn(zigzagScan)
	end
end

UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == TOGGLE_KEY then
		toggle()
	end
end)

print("[Zigzag] Loaded. Press P to start/stop.")
