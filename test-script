--// LocalScript (StarterPlayerScripts)
-- Phase A: Apply 40 HatchTime potions
-- Phase B: Teleport to placed packs in Workspace/Plots/1/Packs and press E to open
-- (Your zigzag placer remains included for later unification.)

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- Remotes
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local cardPack = Remotes:WaitForChild("Card")
local potionRemote = Remotes:WaitForChild("Potion")

-- === QUAD CORNERS (zigzag placement area) ===
local A = Vector3.new(-622.432373, 7.22039652, -92.1760025)
local B = Vector3.new(-621.693604, 7.1538558,  -150.819366)
local C = Vector3.new(-570.654053, 7.1538558,  -152.937439)
local D = Vector3.new(-570.425293, 7.1538558,  -93.1411057)

-- === TUNING (zigzag) ===
local STEP_STUDS = 7.0
local ROW_STEP_STUDS = 7.0
local Y_LIFT = 2.5
local TELEPORT_WAIT = 0.08
local PLACE_EVERY_N_STEPS = 1
local PACK_NAME = "Note-Emerald"
local PLACE_COOLDOWN = 0.08

-- === TUNING (follow-ups) ===
local POTION_NAME = "HatchTime1"
local POTION_USES = 40
local POTION_DELAY = 0.10       -- delay between potion fires (raise if throttled)

local OPEN_KEY = Enum.KeyCode.E
local OPEN_AFTER_TELEPORT_DELAY = 0.12  -- let UI/prompt settle before pressing E
local BETWEEN_PACKS_DELAY = 0.05        -- tiny pacing between packs
local OPEN_PRESS_DURATION = 0.05        -- how long to hold E down

-- Plot path
local PLOTS_FOLDER_NAME = "Plots"
local PLOT_ID_FOLDER_NAME = "1"
local PLACED_PACKS_FOLDER_NAME = "Packs"

-- Toggle key for running follow-ups now (separate from zigzag for the moment)
local RUN_FOLLOWUPS_KEY = Enum.KeyCode.O  -- press O to run potion+open flow
local RUN_ZIGZAG_KEY = Enum.KeyCode.P     -- your existing zigzag toggle

-- === Helpers ===
local function getCharacterParts()
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart", 5)
	local hum = char:FindFirstChildOfClass("Humanoid")
	return char, hrp, hum
end

local function v3Lerp(a, b, t)
	return a + (b - a) * t
end

local function stepsForDistance(dist, step)
	return math.max(1, math.floor(dist / step + 0.5))
end

local function teleportTo(hrp, pos, lookDir)
	local p = pos + Vector3.new(0, Y_LIFT, 0)
	if lookDir and lookDir.Magnitude > 1e-6 then
		hrp.CFrame = CFrame.lookAt(p, p + lookDir.Unit)
	else
		hrp.CFrame = CFrame.new(p)
	end
end

local function placePack()
	cardPack:FireServer("Place", PACK_NAME)
end

local function pressKey(keyCode, holdSeconds)
	-- KeyDown
	VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
	task.wait(holdSeconds or 0.03)
	-- KeyUp
	VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
end

local function getModelWorldPos(model: Model): Vector3?
	-- Prefer pivot (works even without PrimaryPart)
	if model and model:IsA("Model") then
		local ok, pivot = pcall(function()
			return model:GetPivot()
		end)
		if ok and pivot then
			return pivot.Position
		end

		if model.PrimaryPart then
			return model.PrimaryPart.Position
		end

		local pp = model:FindFirstChildWhichIsA("BasePart", true)
		if pp then
			return pp.Position
		end
	end
	return nil
end

local function getPlacedPacksFolder()
	local plots = Workspace:FindFirstChild(PLOTS_FOLDER_NAME)
	if not plots then return nil end
	local plot = plots:FindFirstChild(PLOT_ID_FOLDER_NAME)
	if not plot then return nil end
	local packs = plot:FindFirstChild(PLACED_PACKS_FOLDER_NAME)
	return packs
end

local function applyPotions(count)
	print(("[FollowUps] Applying %d potions (%s)..."):format(count, POTION_NAME))
	for i = 1, count do
		potionRemote:FireServer("Apply", POTION_NAME)
		if POTION_DELAY > 0 then
			task.wait(POTION_DELAY)
		end
	end
	print("[FollowUps] Potion phase complete.")
end

local function openAllPlacedPacks()
	local _, hrp = getCharacterParts()
	if not hrp then
		warn("[FollowUps] No HumanoidRootPart found.")
		return
	end

	local packsFolder = getPlacedPacksFolder()
	if not packsFolder then
		warn(("[FollowUps] Could not find folder: Workspace/%s/%s/%s"):format(
			PLOTS_FOLDER_NAME, PLOT_ID_FOLDER_NAME, PLACED_PACKS_FOLDER_NAME
		))
		return
	end

	local models = {}
	for _, child in ipairs(packsFolder:GetChildren()) do
		if child:IsA("Model") then
			table.insert(models, child)
		end
	end

	print(("[FollowUps] Found %d placed pack models to open."):format(#models))
	if #models == 0 then return end

	-- Optional optimization: open nearest-next to reduce travel
	local function distToHRP(m)
		local p = getModelWorldPos(m)
		if not p then return math.huge end
		return (p - hrp.Position).Magnitude
	end

	-- Greedy nearest-neighbor ordering
	local ordered = {}
	local remaining = table.clone(models)
	while #remaining > 0 do
		table.sort(remaining, function(m1, m2)
			return distToHRP(m1) < distToHRP(m2)
		end)
		table.insert(ordered, table.remove(remaining, 1))
	end

	for i, model in ipairs(ordered) do
		local pos = getModelWorldPos(model)
		if pos then
			print(("[FollowUps] (%d/%d) Teleporting to: %s"):format(i, #ordered, model.Name))

			-- Face the model so "E" prompt is more likely to register (if directional)
			local lookDir = (pos - hrp.Position)
			teleportTo(hrp, pos, lookDir)

			task.wait(OPEN_AFTER_TELEPORT_DELAY)
			pressKey(OPEN_KEY, OPEN_PRESS_DURATION)

			if BETWEEN_PACKS_DELAY > 0 then
				task.wait(BETWEEN_PACKS_DELAY)
			end
		else
			warn("[FollowUps] Could not resolve world position for model:", model.Name)
		end
	end

	print("[FollowUps] Open phase complete.")
end

-- === Zigzag scan (unchanged logic, just included for later unification) ===
local zigzagRunning = false

local function zigzagScan()
	local _, hrp = getCharacterParts()
	if not hrp then
		warn("[Zigzag] No HumanoidRootPart found.")
		return
	end

	print("[Zigzag] Starting scan... (toggle with P to stop)")

	local topLen = (C - B).Magnitude
	local leftLen = (A - B).Magnitude

	local cols = stepsForDistance(topLen, STEP_STUDS)
	local rows = stepsForDistance(leftLen, ROW_STEP_STUDS)

	print(string.format("[Zigzag] cols=%d rows=%d (STEP=%.2f ROW_STEP=%.2f)", cols, rows, STEP_STUDS, ROW_STEP_STUDS))
	print(string.format("[Zigzag] TELEPORT_WAIT=%.3f PLACE_COOLDOWN=%.3f", TELEPORT_WAIT, PLACE_COOLDOWN))

	local globalStep = 0
	local nextPlaceTime = 0

	for r = 0, rows do
		if not zigzagRunning then break end

		local rt = r / rows
		local rowStart = v3Lerp(B, A, rt)
		local rowEnd   = v3Lerp(C, D, rt)
		local rowDir = (rowEnd - rowStart)
		local leftToRight = (r % 2 == 0)

		for c = 0, cols do
			if not zigzagRunning then break end

			local ct = c / cols
			local t = leftToRight and ct or (1 - ct)
			local pos = v3Lerp(rowStart, rowEnd, t)

			teleportTo(hrp, pos, rowDir)

			if TELEPORT_WAIT > 0 then
				task.wait(TELEPORT_WAIT)
			end

			globalStep += 1
			if (globalStep % PLACE_EVERY_N_STEPS) == 0 then
				local now = os.clock()
				if now >= nextPlaceTime then
					placePack()
					nextPlaceTime = now + PLACE_COOLDOWN
				end
			end
		end
	end

	print("[Zigzag] Scan finished.")
	zigzagRunning = false
end

-- === Follow-ups runner ===
local followupsRunning = false
local function runFollowups()
	if followupsRunning then
		print("[FollowUps] Already running.")
		return
	end
	followupsRunning = true

	task.spawn(function()
		print("[FollowUps] Starting potion + open flow...")

		-- Phase A
		applyPotions(POTION_USES)

		-- Phase B
		openAllPlacedPacks()

		print("[FollowUps] All done.")
		followupsRunning = false
	end)
end

-- Input binds
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end

	if input.KeyCode == RUN_ZIGZAG_KEY then
		zigzagRunning = not zigzagRunning
		print("[Zigzag] Running:", zigzagRunning)
		if zigzagRunning then
			task.spawn(zigzagScan)
		end

	elseif input.KeyCode == RUN_FOLLOWUPS_KEY then
		runFollowups()
	end
end)

print("[Loaded] P = toggle zigzag place | O = run follow-ups (40 potions then open placed packs)")
