--// MerchantStand Serverhop Scanner (Client)
--// PlaceId: 76285745979410
--// Scan: Workspace -> Items -> Merchant -> Client -> Model "MerchantStand"
--// If found: teleport to it + print, pause auto hop until P is pressed
--// If not found: no prints, keep hopping

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LP = Players.LocalPlayer

-- =========================
-- Config
-- =========================
local TARGET_PLACE_ID = 76285745979410
local TARGET_MODEL_NAME = "MerchantStand"

local HOP_DELAY_SECONDS = 1.25
local POST_TELEPORT_GRACE = 2.0
local SERVER_PAGE_LIMIT = 100
local AVOID_FULL_SERVERS = true
local MIN_PLAYERS_IN_SERVER = 0

local VISITED_CACHE_MAX = 300

-- =========================
-- Globals (persist if executor keeps getgenv())
-- =========================
getgenv()._JJ_MerchantHop = getgenv()._JJ_MerchantHop or {
    visited = {},
    visitedOrder = {},
    manualHopRequested = false,
    foundInThisServer = false,
}

local STATE = getgenv()._JJ_MerchantHop

local function markVisited(serverId)
    if STATE.visited[serverId] then return end
    STATE.visited[serverId] = true
    table.insert(STATE.visitedOrder, serverId)

    if #STATE.visitedOrder > VISITED_CACHE_MAX then
        local old = table.remove(STATE.visitedOrder, 1)
        if old then
            STATE.visited[old] = nil
        end
    end
end

local function clearVisited()
    STATE.visited = {}
    STATE.visitedOrder = {}
end

local function getCharRoot()
    local char = LP.Character or LP.CharacterAdded:Wait()
    local root = char:FindFirstChild("HumanoidRootPart")
    if root then return char, root end

    local t0 = time()
    while time() - t0 < 10 do
        char = LP.Character
        if char then
            root = char:FindFirstChild("HumanoidRootPart")
            if root then return char, root end
        end
        RunService.Heartbeat:Wait()
    end

    return LP.Character, (LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")) or nil
end

-- =========================
-- Find MerchantStand
-- =========================
local function findMerchantStand()
    local items = workspace:FindFirstChild("Items")
    if not items then return nil end

    local merchant = items:FindFirstChild("Merchant")
    if not merchant then return nil end

    local client = merchant:FindFirstChild("Client")
    if not client then return nil end

    local stand = client:FindFirstChild(TARGET_MODEL_NAME)
    if stand and stand:IsA("Model") then
        return stand
    end

    return nil
end

local function modelCFrame(model)
    if not model or not model:IsA("Model") then return nil end

    if model.PrimaryPart then
        return model.PrimaryPart.CFrame
    end

    -- robust fallback: any part inside the model
    local part = model:FindFirstChildWhichIsA("BasePart", true)
    if part then
        return part.CFrame
    end

    return nil
end

local function teleportToModel(model)
    local _, root = getCharRoot()
    if not root then return false end

    local cf = modelCFrame(model)
    if not cf then return false end

    root.CFrame = cf + Vector3.new(0, 3, 0)
    return true
end

-- =========================
-- Server list + hop
-- =========================
local function fetchServerPage(cursor)
    local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=%d"):format(
        TARGET_PLACE_ID,
        SERVER_PAGE_LIMIT
    )
    if cursor and cursor ~= "" then
        url = url .. "&cursor=" .. HttpService:UrlEncode(cursor)
    end

    local body = HttpService:GetAsync(url)
    return HttpService:JSONDecode(body)
end

local function chooseNextServer()
    local cursor = ""
    local picked = nil

    for _page = 1, 10 do
        local ok, data = pcall(fetchServerPage, cursor)
        if not ok or type(data) ~= "table" then
            return nil
        end

        if type(data.data) == "table" then
            for _, srv in ipairs(data.data) do
                local id = srv.id
                local playing = srv.playing or 0
                local maxPlayers = srv.maxPlayers or 0

                local notVisited = (id and not STATE.visited[id])
                local notFull = (not AVOID_FULL_SERVERS) or (maxPlayers == 0 or playing < maxPlayers)
                local meetsMin = (playing >= MIN_PLAYERS_IN_SERVER)

                if notVisited and notFull and meetsMin then
                    picked = id
                    break
                end
            end
        end

        if picked then break end
        cursor = data.nextPageCursor
        if not cursor then break end
    end

    if not picked then
        clearVisited()
        local ok2, data2 = pcall(fetchServerPage, "")
        if ok2 and type(data2) == "table" and type(data2.data) == "table" then
            for _, srv in ipairs(data2.data) do
                local id = srv.id
                local playing = srv.playing or 0
                local maxPlayers = srv.maxPlayers or 0
                local notFull = (not AVOID_FULL_SERVERS) or (maxPlayers == 0 or playing < maxPlayers)
                local meetsMin = (playing >= MIN_PLAYERS_IN_SERVER)
                if id and notFull and meetsMin then
                    picked = id
                    break
                end
            end
        end
    end

    return picked
end

local function hopServers()
    local nextId = chooseNextServer()
    if not nextId then
        TeleportService:Teleport(TARGET_PLACE_ID, LP)
        return
    end

    markVisited(nextId)
    TeleportService:TeleportToPlaceInstance(TARGET_PLACE_ID, nextId, LP)
end

-- =========================
-- Manual hop on P
-- =========================
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.P then
        STATE.manualHopRequested = true
    end
end)

-- =========================
-- Main loop
-- =========================
task.spawn(function()
    task.wait(POST_TELEPORT_GRACE)

    STATE.foundInThisServer = false
    STATE.manualHopRequested = false

    while true do
        if STATE.manualHopRequested then
            STATE.manualHopRequested = false
            STATE.foundInThisServer = false
            hopServers()
            return
        end

        if not STATE.foundInThisServer then
            local stand = findMerchantStand()
            if stand then
                teleportToModel(stand)
                STATE.foundInThisServer = true
                print("Merchant Found! Press P to continue searching")
            else
                task.wait(HOP_DELAY_SECONDS)
                hopServers()
                return
            end
        end

        RunService.Heartbeat:Wait()
    end
end)
